<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Life Productivity — To-Do App (fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* Prevent horizontal rumble */
  html, body { overflow-x: hidden; height:100%; margin:0; font-family:Inter,system-ui,Arial,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Helvetica; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; background:#0f1724; color:#94a3b8; }

  /* Theme vars */
  :root { --bg:#0f1724; --card:#0b1320; --accent:#6ee7b7; --muted:#94a3b8; --glass:rgba(255,255,255,0.04); --danger:#ff6b6b; --success:#2dd4bf; }
  [data-theme="light"]{ --bg:#f5f7fb; --card:#fff; --accent:#0ea5a3; --muted:#6b7280; --glass:rgba(0,0,0,0.04); }

  body { background:var(--bg); display:flex; align-items:flex-start; justify-content:center; padding:18px; box-sizing:border-box; }

  #themeParticles { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }

  .app { width:100%; max-width:1150px; z-index:2; }

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#042;background:linear-gradient(135deg,var(--accent),#60a5fa);box-shadow:0 10px 30px rgba(0,0,0,0.45)}
  .title{font-size:18px;color:var(--accent);font-weight:700}
  .subtitle{font-size:12px;color:var(--muted)}

  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 26px rgba(2,6,23,0.6);color:var(--muted);backdrop-filter: blur(6px);position:relative}

  .row{display:flex;gap:12px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .btn{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#60a5fa);color:#042;font-weight:700;cursor:pointer}
  .small-btn{padding:6px 8px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

  /* layout: main + right rail */
  .layout { display:grid; gap:16px; grid-template-columns: 1fr 300px; align-items:start; }
  .main-area { min-height:420px; }
  nav.side { position:sticky; top:18px; }

  /* tiles */
  .tiles { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
  .tile { padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); cursor:pointer; }

  /* task list */
  .task-list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .task{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .task .left{display:flex;align-items:center;gap:12px;min-width:0}
  .checkbox{width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,0.08);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;flex:0 0 26px}
  .checkbox.checked{background:linear-gradient(90deg,var(--accent),#60a5fa);border:none;color:#042}
  .task-title{font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .task-meta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .progress{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0%;transition:width .5s ease}

  /* modal (always attach to body) */
  .modal { z-index: 9999; position: fixed; inset: 0; display: none; align-items: center; justify-content: center; pointer-events:auto; background: rgba(0,0,0,0.45); }
  .modal.open{display:flex}
  .modal .modal-card{width:100%;max-width:640px;margin:12px;max-height:90vh;overflow:auto}

  /* responsive */
  @media(max-width:980px){ .layout{grid-template-columns:1fr 280px} .tiles{grid-template-columns:repeat(2,1fr);} }
  @media(max-width:760px){
    body { padding:12px; }
    .layout{grid-template-columns:1fr}
    nav.side{position:relative;top:auto}
    .tiles{grid-template-columns:1fr}
  }

  /* particles minor */
  .particle{position:absolute;will-change:transform,opacity;pointer-events:none}
  @keyframes fall { 0%{transform:translateY(-10vh);opacity:0}10%{opacity:0.9}100%{transform:translateY(110vh);opacity:0.9} }
  .snow{font-size:var(--size,16px);animation:fall var(--dur,10s) linear var(--delay,0s) infinite}
</style>
</head>
<body data-theme="dark">
  <div id="themeParticles" aria-hidden="true"></div>

  <div class="app" role="application">
    <header>
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <div class="title">Life Productivity</div>
          <div class="subtitle">Organize. Prioritize. Finish.</div>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <div id="userArea" style="text-align:right"></div>
        <div class="row" style="gap:10px;align-items:center">
          <div id="pointsDisplay" style="background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px">Points: 0</div>
          <div id="rankDisplay" style="background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px">Rank: —</div>
          <div class="theme-select" style="display:flex;align-items:center;gap:6px">
            <label for="themeSelect" style="font-size:13px;color:var(--muted);margin-right:6px">Theme</label>
            <select id="themeSelect" aria-label="Choose theme">
              <option value="dark">Dark</option><option value="light">Light</option><option value="halloween">Halloween</option><option value="christmas">Christmas</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <!-- AUTH -->
    <div id="authArea" class="card" style="margin-bottom:16px">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div style="flex:1;min-width:240px">
          <input id="quickUser" placeholder="username" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px" />
          <input id="quickPass" placeholder="password" type="password" style="width:100%;padding:10px;border-radius:8px" />
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="quickSignIn" class="btn">Sign in</button>
          <button id="openCreate" class="btn ghost">Create</button>
          <div id="accountList" class="muted" style="font-size:13px"></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appRoot" style="display:none">
      <div class="layout">
        <main class="main-area">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <div>
                <h2 id="currentSectionTitle" style="margin:0;color:#fff">Home</h2>
                <div id="nextTaskBar" class="muted" style="margin-top:6px">Next task: —</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="searchInput" class="muted" placeholder="Search tasks..." style="padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit">
                <button id="addTaskBtn" class="btn">+ New Task</button>
                <button id="manualBtn" class="small-btn">User manual</button>
                <button id="signOutBtn" class="small-btn">Sign out</button>
              </div>
            </div>

            <div style="display:flex;gap:16px;align-items:flex-start">
              <div style="flex:1">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="muted">Tasks</div>
                  <div class="muted">Section progress</div>
                </div>

                <div class="task-list" id="taskList"></div>

                <div style="margin-top:12px">
                  <div class="muted">Completion</div>
                  <div class="progress" style="margin-top:6px"><i id="progressBar"></i></div>
                  <div id="progressText" class="muted" style="margin-top:6px">0 of 0 tasks completed</div>
                  <div id="encourageMsg" style="margin-top:8px;font-weight:700;color:var(--accent)"></div>
                </div>
              </div>

              <aside style="width:300px">
                <div class="card" style="margin-bottom:12px">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                      <div style="font-weight:700;color:var(--accent)">Account</div>
                      <div id="accountName" class="muted"></div>
                    </div>
                    <div style="text-align:right">
                      <div id="userPoints" class="muted">Points: 0</div>
                      <div id="userRank" class="muted">Rank: —</div>
                    </div>
                  </div>
                </div>

                <div class="card" style="margin-bottom:12px">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div style="font-weight:700;color:var(--accent)">Sections</div>
                    <div class="muted" style="font-size:12px">Pick workspace</div>
                  </div>
                  <div id="sectionList"></div>
                </div>

                <div class="card">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div style="font-weight:700;color:var(--accent)">Task history</div>
                    <div class="muted" style="font-size:12px">Past 12 items</div>
                  </div>
                  <div id="historyList" style="margin-top:8px"></div>
                </div>
              </aside>
            </div>
          </div>
        </main>

        <nav class="side">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <div>
                <div style="font-weight:700;color:var(--accent)">Home Tiles</div>
                <div class="muted" style="font-size:13px">Quick pick a section</div>
              </div>
            </div>
            <div id="homeTiles" class="tiles">
              <div class="tile" data-section="Personal"><h3>Personal</h3><p class="muted">Habits & personal goals</p></div>
              <div class="tile" data-section="Home"><h3>Home</h3><p class="muted">Chores & upkeep</p></div>
              <div class="tile" data-section="School"><h3>School</h3><p class="muted">Assignments & study</p></div>
              <div class="tile" data-section="Work"><h3>Work</h3><p class="muted">Jobs & projects</p></div>
              <div class="tile" data-section="Community"><h3>Community</h3><p class="muted">Volunteering & events</p></div>
            </div>

            <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:700;color:var(--accent)">Leaderboard</div>
                <div class="muted" style="font-size:12px">Top local users</div>
              </div>
              <div id="leaderboard" style="margin-top:8px"></div>
            </div>
          </div>
        </nav>
      </div>
    </div>
  </div>

  <!-- modal for create/edit task (kept separate to avoid overwritten innerHTML) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card card" style="padding:18px">
      <h3 id="modalTitle" style="margin-top:0;color:var(--accent)">New Task</h3>
      <div class="form-row"><label>Title</label><input id="taskTitle" style="width:100%;padding:10px;border-radius:8px"></div>
      <div class="form-row"><label>Notes</label><input id="taskNotes" style="width:100%;padding:10px;border-radius:8px"></div>
      <div class="form-row"><label>Reward (describe)</label><input id="taskReward" style="width:100%;padding:10px;border-radius:8px" placeholder="e.g. 10 points or watch 30m show"></div>
      <div class="form-row"><label>Points awarded (numeric)</label><input id="taskPoints" type="number" style="width:100%;padding:10px;border-radius:8px" placeholder="e.g. 10"></div>
      <div class="form-row"><label>Due date & time (optional)</label><input id="taskDue" type="datetime-local" style="width:100%;padding:10px;border-radius:8px"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label style="font-size:13px" title="Notify by email when reminder threshold is reached">
          <input id="taskEmailRem" type="checkbox"> Email reminder (open mail client)
        </label>
        <label style="font-size:13px;margin-left:6px">
          Reminder before:
          <select id="reminderBefore">
            <option value="86400000">1 day before</option>
            <option value="3600000">1 hour before</option>
            <option value="0">At due time</option>
          </select>
        </label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="cancelModal" class="small-btn">Cancel</button>
        <button id="saveTaskBtn" class="btn">Save Task</button>
      </div>
    </div>
  </div>

<script>
/* Lightweight single-file app with fixes:
   - Modal appended to body on load
   - Event delegation for save button and Add Task (robust if modal content changes)
   - Layout adjustments to avoid overflow
*/

const STORAGE_KEY = 'LP_FIXED_V1';
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => Array.from((el||document).querySelectorAll(s));
const uid = ()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);

// default sections & tasks
const defaultSections = {
  'Personal': [{title:'Morning stretch', notes:'10 minutes', points:5, reward:'Energy'}],
  'Home': [{title:'Do dishes', notes:'Wash and dry dishes', points:3, reward:'Clean sink'}, {title:'Sweep floor', notes:'Quick sweep', points:3, reward:'Tidy kitchen'}, {title:'Fold clothes', notes:'Fold laundry', points:4, reward:'Neat closet'}],
  'School': [{title:'Review notes', notes:'Revise lessons', points:6, reward:'Better grades'}],
  'Work': [{title:'Email updates', notes:'Send daily updates', points:5, reward:'Stay aligned'}],
  'Community': [{title:'Volunteer check', notes:'Plan volunteering', points:6, reward:'Give back'}]
};

let state = { users: {}, currentUser: null, currentSection: 'Home', editingTaskId: null, reminderQueue: [] };

function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw){ state = { users:{}, currentUser:null, currentSection:'Home', editingTaskId:null, reminderQueue:[] }; return; } state = JSON.parse(raw); if(!state.users) state = { users:{}, currentUser:null, currentSection:'Home', editingTaskId:null, reminderQueue:[] }; }catch(e){ console.warn('load error',e); state = { users:{}, currentUser:null, currentSection:'Home', editingTaskId:null, reminderQueue:[] }; } }
function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn('save failed',e); } }

function ensureUser(u, email){ if(!u) return; if(!state.users[u]){ state.users[u] = { password:'', email: email||'', points:0, theme:'dark', createdAt: Date.now(), sections: {} }; Object.keys(defaultSections).forEach(sec=>{ state.users[u].sections[sec] = { tasks: [] }; defaultSections[sec].forEach(t=> state.users[u].sections[sec].tasks.push({ id: uid(), title:t.title, notes:t.notes||'', points:t.points||0, reward:t.reward||'', due:null, createdAt:Date.now(), completed:false, completedAt:null, archived:false, status:'not', emailReminder:false, reminderBefore:86400000 })); }); } else { Object.keys(defaultSections).forEach(sec=>{ if(!state.users[u].sections[sec]) state.users[u].sections[sec] = { tasks: [] }; }); } }

const particleContainer = document.getElementById('themeParticles');
function rand(min,max){ return Math.random()*(max-min)+min; }
function createSnow(count=24){ if(!particleContainer) return; particleContainer.innerHTML=''; for(let i=0;i<count;i++){ const sp=document.createElement('div'); sp.className='particle snow'; sp.textContent='❄'; sp.style.left = rand(0,100)+'vw'; sp.style.setProperty('--size',Math.round(rand(12,28))+'px'); sp.style.setProperty('--dur',rand(6,16).toFixed(2)+'s'); sp.style.setProperty('--delay',rand(0,8).toFixed(2)+'s'); sp.style.opacity=(rand(0.5,0.95)).toFixed(2); particleContainer.appendChild(sp);} }

const GLOBAL_THEME_KEY = 'lp_global_theme_v1';
function applyTheme(t){ if(!t) t='dark'; document.body.setAttribute('data-theme', t); const sel = qs('#themeSelect'); if(sel) sel.value = t; if(t==='christmas') createSnow(28); else particleContainer.innerHTML=''; }
function saveGlobalTheme(t){ try{ localStorage.setItem(GLOBAL_THEME_KEY,t); }catch(e){} }
function restoreUserTheme(){ load(); const u = state.currentUser; if(u && state.users[u] && state.users[u].theme) applyTheme(state.users[u].theme); else applyTheme(localStorage.getItem(GLOBAL_THEME_KEY) || 'dark'); }

// UI helpers
function showAuthArea(){ qs('#authArea').style.display='block'; qs('#appRoot').style.display='none'; populateAccountList(); }
function showApp(){ qs('#authArea').style.display='none'; qs('#appRoot').style.display='block'; restoreUserTheme(); renderAccount(); renderSections(); renderHomeTiles(); renderSectionView(); startTicker(); renderLeaderboard(); }

// accounts UI
function populateAccountList(){ const container = qs('#accountList'); if(!container) return; container.innerHTML=''; const names = Object.keys(state.users); if(!names.length){ container.innerHTML = '<span class="muted">No accounts</span>'; return; } names.forEach(n=>{ const el = document.createElement('div'); el.style.display='inline-block'; el.style.marginLeft='8px'; el.innerHTML = `<button class="small-btn pick" data-u="${n}">${n}</button>`; container.appendChild(el); }); qsa('.pick').forEach(b=> b.addEventListener('click', e=> { qs('#quickUser').value = e.currentTarget.dataset.u; qs('#quickPass').value = state.users[e.currentTarget.dataset.u].password || ''; })); }

function handleCreate(u,p,email){ if(!u||!p){ alert('Enter username and password'); return; } load(); ensureUser(u,email); state.users[u].password = p; state.users[u].email = email || ''; state.currentUser = u; state.currentSection = 'Home'; save(); showApp(); }
function handleSignIn(u,p){ load(); if(!u || !state.users[u] || state.users[u].password !== p){ alert('Invalid user or password (create account if new)'); return; } state.currentUser = u; state.currentSection = state.currentSection || 'Home'; save(); showApp(); }

// render
function renderAccount(){ if(!state.currentUser) return; qs('#accountName').textContent = state.currentUser; qs('#userArea').innerHTML = `<div class="muted">${state.currentUser}</div>`; qs('#userPoints').textContent = `Points: ${state.users[state.currentUser].points || 0}`; qs('#pointsDisplay').textContent = `Points: ${state.users[state.currentUser].points || 0}`; renderRankForUser(); }
function renderRankForUser(){ const list = Object.keys(state.users).map(u=>({u,points:state.users[u].points||0})).sort((a,b)=>b.points-a.points); const idx = list.findIndex(x=>x.u === state.currentUser); const rank = idx>=0?idx+1:'—'; qs('#userRank').textContent = `Rank: ${rank}`; qs('#rankDisplay').textContent = `Rank: ${rank}`; }

function renderSections(){ const container = qs('#sectionList'); if(!container) return; container.innerHTML=''; const secs = Object.keys(state.users[state.currentUser].sections||{}); secs.forEach(s=>{ const tasks = state.users[state.currentUser].sections[s].tasks || []; const total = tasks.filter(t=>!t.archived).length; const done = tasks.filter(t=>t.completed).length; const percent = total? Math.round((done/total)*100):0; const el = document.createElement('div'); el.className='card'; el.style.padding='8px'; el.style.marginBottom='8px'; el.style.cursor='pointer'; el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong style="color:var(--accent)">${s}</strong><div class="muted" style="font-size:12px">${done}/${total} done • ${percent}%</div></div><div class="muted" style="font-size:12px">${tasks.length} items</div></div>`; el.addEventListener('click', ()=>{ state.currentSection = s; save(); renderSectionView(); renderSections(); }); container.appendChild(el); }); }

function renderHomeTiles(){ qsa('.tile').forEach(t=> t.addEventListener('click', ()=>{ state.currentSection = t.dataset.section; save(); renderSectionView(); renderSections(); })); }

function getTasks(){ try{ return state.users[state.currentUser].sections[state.currentSection].tasks || []; }catch(e){ return []; } }
function renderTaskList(filter=''){ const list = qs('#taskList'); if(!list) return; list.innerHTML = ''; const tasks = getTasks().filter(t=>!t.archived && (!filter || t.title.toLowerCase().includes(filter.toLowerCase()))).sort((a,b)=> (a.due||0) - (b.due||0)); if(!tasks.length){ list.innerHTML = '<div class="muted">No tasks. Click + New Task to add one.</div>'; return; } tasks.forEach(t=>{ const el = document.createElement('div'); el.className='task'; const left = document.createElement('div'); left.className='left'; const cb = document.createElement('div'); cb.className = 'checkbox' + (t.completed? ' checked':''); cb.innerHTML = t.completed ? '✔' : ''; cb.addEventListener('click', ()=>{ toggleComplete(t); }); const status = document.createElement('select'); status.innerHTML = '<option value="not">Not</option><option value="partial">Partial</option><option value="done">Done</option>'; status.value = t.status || 'not'; status.addEventListener('change', e=>{ handleStatusChange(t, e.target.value); }); const info = document.createElement('div'); info.style.minWidth='0'; info.innerHTML = `<div class="task-title">${escapeHtml(t.title)}</div><div class="task-meta">${t.due? 'Due: '+new Date(t.due).toLocaleString() : 'No due date'} ${t.notes? ' • '+escapeHtml(t.notes):''}</div><div class="muted" style="font-size:12px">Reward: ${escapeHtml(t.reward || '—')} • Points: ${t.points||0}</div>`; left.appendChild(cb); left.appendChild(status); left.appendChild(info); const actions = document.createElement('div'); actions.className='task-actions'; const edit = document.createElement('button'); edit.className='small-btn'; edit.textContent='Edit'; edit.addEventListener('click', ()=> openModal(t.id)); const del = document.createElement('button'); del.className='small-btn'; del.textContent='Delete'; del.addEventListener('click', ()=>{ if(confirm('Delete this task?')){ t.archived=true; save(); renderTaskList(qs('#searchInput')?.value || ''); updateProgress(); renderHistoryList(); renderSections(); renderLeaderboard(); } }); const remind = document.createElement('button'); remind.className='small-btn'; remind.textContent='Remind'; remind.addEventListener('click', ()=>{ if(!t.due){ alert('Set due date first'); return; } showReminder(t); }); actions.appendChild(edit); actions.appendChild(del); actions.appendChild(remind); el.appendChild(left); el.appendChild(actions); list.appendChild(el); }); }

function toggleComplete(t){ if(!t.completed){ t.completed = true; t.completedAt = Date.now(); t.status = 'done'; const pts = Number(t.points)||0; state.users[state.currentUser].points = (state.users[state.currentUser].points||0) + pts; showEncouragement(pts,t); } else { t.completed = false; t.completedAt = null; if(t.status==='done'){ state.users[state.currentUser].points = Math.max(0, (state.users[state.currentUser].points||0) - (Number(t.points)||0)); } t.status='not'; } save(); renderTaskList(qs('#searchInput')?.value||''); updateProgress(); renderAccount(); renderSections(); renderLeaderboard(); }

function handleStatusChange(t,val){ if(val==='done' && !t.completed){ t.completed = true; t.completedAt = Date.now(); const pts = Number(t.points)||0; state.users[state.currentUser].points = (state.users[state.currentUser].points||0) + pts; showEncouragement(pts,t); } else if(val==='partial'){ if(t.status !== 'partial'){ const half = Math.round((Number(t.points)||0)/2); state.users[state.currentUser].points = (state.users[state.currentUser].points||0) + half; showEncouragement(half,t,true); } t.completed = false; } else if(val==='not'){ t.completed = false; } t.status = val; save(); renderTaskList(qs('#searchInput')?.value||''); updateProgress(); renderAccount(); renderLeaderboard(); }

function renderHistoryList(){ const hist = qs('#historyList'); if(!hist) return; hist.innerHTML=''; const tasksAll = (state.users[state.currentUser].sections[state.currentSection].tasks || []); const histTasks = tasksAll.filter(t => (t.archived === true) || (t.completed === true) || (t.status === 'partial')); if(!histTasks.length){ hist.innerHTML = '<div class="muted">No past tasks</div>'; return; } histTasks.sort((a,b)=>{ const ta = a.completedAt || a.createdAt || 0; const tb = b.completedAt || b.createdAt || 0; return tb - ta; }).slice(0,12).forEach(t=>{ const d = document.createElement('div'); d.style.padding='8px 0'; const when = (t.completedAt || t.createdAt) ? (t.completedAt ? `Completed: ${new Date(t.completedAt).toLocaleString()}` : `Created: ${new Date(t.createdAt).toLocaleString()}`) : ''; d.innerHTML = `<div style="font-weight:700;color:#fff">${escapeHtml(t.title)}</div><div class="muted" style="font-size:12px">${when} • Reward: ${escapeHtml(t.reward || '—')}</div>`; hist.appendChild(d); }); }

function updateProgress(){ try{ const tasks = getTasks().filter(t=>!t.archived); const total = tasks.length; const done = tasks.filter(t=>t.completed).length; const partial = tasks.filter(t=>t.status==='partial').length; const effective = done + partial*0.5; const percent = total? Math.round((effective/total)*100):0; if(qs('#progressBar')) qs('#progressBar').style.width = percent+'%'; if(qs('#progressText')) qs('#progressText').textContent = `${Math.round(effective*100)/100} of ${total} tasks completed (${percent}%)`; }catch(e){console.warn(e);} }

function updateNextTask(){ const tasks = getTasks().filter(t=>!t.completed && !t.archived && t.due).sort((a,b)=> a.due - b.due); const nt = tasks[0] || null; if(!nt){ qs('#nextTaskBar').textContent = 'Next task: —'; return; } qs('#nextTaskBar').textContent = `Next: ${nt.title} — due ${new Date(nt.due).toLocaleString()}`; }

const encouragements = ["Nice! Keep going — little wins add up.","Great job! Earn more points by completing another task.","You're on a roll — don't stop now!","Fantastic — consistent progress builds momentum.","Way to go! Reward yourself (you earned it)."];
function showEncouragement(pts, task, partial=false){ const msg = (partial? "Nice progress!" : "Well done!") + ` +${pts} points for "${task.title}".`; const rotate = encouragements[Math.floor(Math.random()*encouragements.length)]; if(qs('#encourageMsg')) qs('#encourageMsg').textContent = msg + ' ' + rotate; setTimeout(()=>{ if(qs('#encourageMsg')) qs('#encourageMsg').textContent = ''; }, 6500); }

// modal open/close
const modal = qs('#modal');
function openModal(taskId){ state.editingTaskId = taskId || null; if(modal && modal.parentElement !== document.body) document.body.appendChild(modal); if(taskId){ const t = getTasks().find(x=>x.id===taskId); if(t){ qs('#modalTitle').textContent='Edit Task'; qs('#taskTitle').value = t.title; qs('#taskNotes').value = t.notes || ''; qs('#taskReward').value = t.reward || ''; qs('#taskPoints').value = t.points || ''; qs('#taskDue').value = t.due? toDatetimeLocal(new Date(t.due)) : ''; qs('#taskEmailRem').checked = !!t.emailReminder; qs('#reminderBefore').value = t.reminderBefore || '86400000'; } } else { qs('#modalTitle').textContent='New Task'; qs('#taskTitle').value=''; qs('#taskNotes').value=''; qs('#taskReward').value=''; qs('#taskPoints').value=''; qs('#taskDue').value=''; qs('#taskEmailRem').checked=false; qs('#reminderBefore').value='86400000'; } modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
function closeModal(){ if(modal) modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); state.editingTaskId = null; }

// save task
function saveTaskFromModal(){
  const title = qs('#taskTitle').value.trim(); if(!title){ alert('Enter title'); return; }
  const notes = qs('#taskNotes').value.trim(); const reward = qs('#taskReward').value.trim(); const points = Number(qs('#taskPoints').value) || 0;
  const dueVal = qs('#taskDue').value; const due = dueVal? new Date(dueVal).getTime(): null;
  const emailRem = !!qs('#taskEmailRem').checked; const reminderBefore = Number(qs('#reminderBefore').value) || 86400000;
  const tasks = state.users[state.currentUser].sections[state.currentSection].tasks;
  if(state.editingTaskId){ const t = tasks.find(x=>x.id===state.editingTaskId); if(t){ t.title = title; t.notes = notes; t.reward = reward; t.points = points; t.due = due; t.emailReminder = emailRem; t.reminderBefore = reminderBefore; t.archived = false; } } else { tasks.push({ id: uid(), title, notes, reward, points, due, createdAt: Date.now(), completed:false, completedAt:null, archived:false, status:'not', emailReminder: emailRem, reminderBefore }); }
  save(); closeModal(); renderTaskList(qs('#searchInput')?.value || ''); updateProgress(); updateNextTask(); renderHistoryList(); renderSections(); renderLeaderboard(); rebuildReminderQueue();
}

// reminders: simple queue persisted in state.reminderQueue
function rebuildReminderQueue(){ state.reminderQueue = state.reminderQueue||[]; const newItems = []; Object.keys(state.users).forEach(u=>{ Object.keys(state.users[u].sections||{}).forEach(sec=>{ (state.users[u].sections[sec].tasks||[]).forEach(t=>{ if(t.emailReminder && t.due){ const trig = (t.due - (t.reminderBefore || 86400000)); const exists = state.reminderQueue.some(r => r.user===u && r.section===sec && r.taskId===t.id); if(!exists){ newItems.push({ user:u, section:sec, taskId:t.id, triggerTime:trig, triggered:false }); } } }); }); }); state.reminderQueue = state.reminderQueue.concat(newItems); save(); }
function checkReminders(){ const now = Date.now(); state.reminderQueue = state.reminderQueue||[]; state.reminderQueue.forEach(r=>{ if(r.triggered) return; if(r.triggerTime <= now){ r.triggered = true; save(); if(r.user === state.currentUser){ const t = state.users[r.user].sections[r.section].tasks.find(x=>x.id===r.taskId); if(t) showReminder(t); } } }); }

const reminderModal = null;
function showReminder(task){ const subject = encodeURIComponent(`Reminder: "${task.title}" is due soon`); const bodyText = encodeURIComponent(`Reminder: "${task.title}" is due on ${task.due?new Date(task.due).toLocaleString():'soon'}.\n\nNotes: ${task.notes||'-'}\nReward: ${task.reward||'-'}`); const email = state.users[state.currentUser].email || ''; if(email) window.location.href = `mailto:${encodeURIComponent(email)}?subject=${subject}&body=${bodyText}`; else window.location.href = `mailto:?subject=${subject}&body=${bodyText}`; }

// encouragement
function showEncouragement(pts, task, partial=false){ const msg = (partial? "Nice progress!" : "Well done!") + ` +${pts} points for "${task.title}".`; const rotate = encouragements[Math.floor(Math.random()*encouragements.length)]; if(qs('#encourageMsg')) qs('#encourageMsg').textContent = msg + ' ' + rotate; setTimeout(()=>{ if(qs('#encourageMsg')) qs('#encourageMsg').textContent = ''; },6500); }

// leaderboard
function renderLeaderboard(){ const container = qs('#leaderboard'); if(!container) return; container.innerHTML=''; const users = Object.keys(state.users).map(u=>({u,points:state.users[u].points||0})).sort((a,b)=>b.points-a.points).slice(0,8); users.forEach((it,idx)=>{ const el = document.createElement('div'); el.style.padding='6px 0'; el.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="min-width:0"><strong style="color:var(--accent)">${idx+1}. ${escapeHtml(it.u)}</strong><div class="muted" style="font-size:12px">Points: ${it.points}</div></div><div class="muted" style="font-size:12px">${it.u===state.currentUser?'You':''}</div></div>`; container.appendChild(el); }); }

// utility
function toDatetimeLocal(date){ const off = date.getTimezoneOffset(); const d = new Date(date.getTime() - off*60*1000); return d.toISOString().slice(0,16); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

// ticker
let ticker = null;
function startTicker(){ if(ticker) clearInterval(ticker); ticker = setInterval(()=>{ updateNextTask(); checkReminders(); },1000); }

// open/close modal safe (append to body once)
document.addEventListener('DOMContentLoaded', ()=>{
  if(modal && modal.parentElement !== document.body) document.body.appendChild(modal);

  // wire auth buttons
  qs('#openCreate').addEventListener('click', ()=> { const cu = prompt('Enter new username'); if(!cu) return; const em = prompt('Email (optional)'); const pw = prompt('Password'); if(!pw){ alert('Password required'); return; } handleCreate(cu,pw,em); });
  qs('#quickSignIn').addEventListener('click', ()=> handleSignIn(qs('#quickUser').value.trim(), qs('#quickPass').value));
  qs('#quickPass').addEventListener('keydown', e=>{ if(e.key==='Enter') handleSignIn(qs('#quickUser').value.trim(), qs('#quickPass').value); });

  // theme
  const themeSel = qs('#themeSelect'); if(themeSel){ themeSel.addEventListener('change', e=>{ const next = e.target.value; applyTheme(next); try{ if(state.currentUser && state.users[state.currentUser]){ state.users[state.currentUser].theme = next; save(); } else saveGlobalTheme(next); }catch(err){} }); }

  // signout
  qs('#signOutBtn').addEventListener('click', ()=>{ load(); state.currentUser=null; save(); location.reload(); });

  // new task button: use delegation in addition to direct binding
  qs('#addTaskBtn').addEventListener('click', ()=> openModal());

  // cancel modal
  qs('#cancelModal').addEventListener('click', ()=> closeModal());

  // search
  qs('#searchInput').addEventListener('input', e=> renderTaskList(e.target.value));

  // manual - simple alert (keeps modal intact)
  qs('#manualBtn').addEventListener('click', ()=> {
    alert('User manual:\n- Create account via Create button\n- Add tasks with + New Task\n- Enable email reminders (will open your mail client at reminder time)\n- Data is stored locally in your browser.');
  });

  // account list populate and initial load
  load(); populateAccountList();
  if(state.currentUser && state.users[state.currentUser]) showApp();

  // ensure reminders queue and start ticker
  rebuildReminderQueue();
  startTicker();
});

// robust click delegation (fixes missing bindings when modal contents are replaced)
document.addEventListener('click', (e)=>{
  // Save Task (delegated)
  if(e.target && e.target.id === 'saveTaskBtn'){
    e.preventDefault();
    saveTaskFromModal();
  }
  // If user clicks an element that should open modal (e.g. programmatic add)
  if(e.target && e.target.id === 'addTaskBtn'){
    e.preventDefault();
    openModal();
  }
});

// small helpers for status toggles already use per-element bindings

// initial load: make sure structure exists
load();
Object.keys(state.users||{}).forEach(u=> Object.keys(defaultSections).forEach(s=> { if(!state.users[u].sections[s]) state.users[u].sections[s] = { tasks: [] }; }));

// expose for debugging in console
window.lp_state = state;
window.lp_save = save;

// simplified functions to show section view
function renderSectionView(){ if(!state.currentUser) return; qs('#currentSectionTitle').textContent = state.currentSection; renderTaskList(qs('#searchInput')?.value||''); renderHistoryList(); updateProgress(); updateNextTask(); renderAccount(); renderSections(); rebuildReminderQueue(); renderLeaderboard(); }

</script>
</body>
</html>
